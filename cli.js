var k=Object.create;var m=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var x=Object.getPrototypeOf,T=Object.prototype.hasOwnProperty;var u=(i,t)=>m(i,"name",{value:t,configurable:!0});var S=(i,t,e,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of P(t))!T.call(i,s)&&s!==e&&m(i,s,{get:()=>t[s],enumerable:!(o=R(t,s))||o.enumerable});return i};var E=(i,t,e)=>(e=i!=null?k(x(i)):{},S(t||!i||!i.__esModule?m(e,"default",{value:i,enumerable:!0}):e,i));var r=require("fs"),g=E(require("child_process")),a=require("path");var d="checksum";var C=!1;function y(i){C=i}u(y,"setLogToConsole");function l(...i){C&&console.log(...i)}u(l,"log");function w({isInit:i,excludeLogin:t}){return[...i?["example.checksum.spec.ts","github-actions.example.yml"]:[],...t?[]:["login.ts"],"checksum.config.ts","playwright.config.ts","README.md",".gitignore.example"]}u(w,"getRuntimeFiles");var p=class{constructor(){this.TEST_RUN_MONITOR_PATH=(0,a.join)(__dirname,"test-run-monitor.js");this.CHECKSUM_API_URL="https://api.checksum.ai";this.CHECKSUM_APP_URL="https://app.checksum.ai";this.didFail=!1;this.isolationMode=!1;this.debugMode=!1;this.completeIndicators={upload:!1,tests:!1,report:!1};this.guardReturn=async(t,e=1e3,o="guardReturnTimedOut")=>{let s="guard-timed-out",n=u(async()=>(await this.awaitSleep(e+1e3),s),"guard"),c=await Promise.race([t,n()]);if(typeof c=="string"&&c===s)throw new Error(o);return c};this.awaitSleep=t=>new Promise(e=>setTimeout(e,t));this.printError=t=>{console.log("\x1B[31m%s\x1B[0m",t)}}async execute(){switch(process.argv.find(t=>t==="--help"||t==="-h")&&(await this.printHelp(process.argv[2]),process.exit(0)),process.argv.find(t=>t==="--clidebug")&&(this.debugMode=!0,y(!0)),process.argv[2]){case"init":this.install();break;case"test":await this.test(process.argv.slice(3));break;case"show-report":this.showReport(process.argv.slice(3));break;default:await this.printHelp()}process.exit(0)}async execCmd(t,e={}){let o={...process.env,...e},s=await g.spawn(t,{env:o,shell:!0,stdio:"inherit"});return new Promise((c,h)=>{s.on("exit",f=>{f===0?c(!0):h(new Error(`Checsum failed execution with code: ${f} `))})})}async getCmdOutput(t){return new Promise(function(e,o){g.exec(t,(s,n,c)=>{if(s){o(`Error executing command: ${s.message}`);return}e(n)})})}async printHelp(t){switch(t){default:console.log(`
Checksum CLI
Usage: checksum [command] [options]

Commands:
init                            installs checksum files and folders
test [options] [test-filter...] runs checksum tests
help                            prints this help message
show-report [options] [report]  show HTML report
`);break;case"test":try{let e="npx playwright test --help",o=(await this.getCmdOutput(e)).replace(/npx playwright/g,"yarn checksum").split(`
`);o.splice(5,0,"  --checksum-config=<config>   Checksum configuration in JSON format").join(`
`),console.log(o.join(`
`))}catch(e){console.log("Error",e.message)}break;case"show-report":try{let e="npx playwright show-report --help",o=(await this.getCmdOutput(e)).replace(/npx playwright/g,"yarn checksum");console.log(o)}catch(e){console.log("Error",e.message)}break}}async showReport(t){let e=`npx playwright show-report ${t.join(" ")}`;try{await this.execCmd(e)}catch(o){console.log("Error showing report",o.message)}}async test(t){if(this.locateChecksumLibs(),this.processChecksumArguments(t),this.setChecksumConfig(),!await this.getSession())return;let e;try{e=await this.guardReturn(this.startTestRunMonitor(this.testSession),1e4,"test run monitor timeout")}catch{console.log("Error starting test run monitor. Test results will not be available on checksum.")}this.buildVolatileConfig();let o={CHECKSUM_ROOT_FOLDER:this.checksumRoot};e&&(o.CHECKSUM_UPLOAD_AGENT_PORT=e),this.config.options.hostReports&&(o.PW_TEST_HTML_REPORT_OPEN="never");let s=`npx playwright test --config ${this.getPlaywrightConfigFile()} ${t.map(n=>`"${n}"`).join(" ")}`;await this.patchPlaywright();try{await this.execCmd(s,o),console.log("Tests execution finished")}catch(n){this.didFail=!0,console.log("Error during test",n.message)}finally{this.sendReportUploadRequest(),await this.patchPlaywright(!0),this.completeIndicators.tests=!0,await this.handleCompleteMessage()}}sendReportUploadRequest(){this.isolationMode||console.log("Waiting for test files to upload to Checksum..");let t=this.getPlaywrightReportPath();if(!(0,r.existsSync)(t)){console.log(`Could not find report file at ${t}`);return}l("Sending report upload request",t),this.testRunMonitorProcess.stdin.write(`cli:report=${t}`)}async patchPlaywright(t=!1){l("Patching playwright",t);let e=`node ${(0,a.join)(__dirname,"scripts/patch.js")}${t?" off":""}`;try{await this.execCmd(e,{PROJECT_ROOT:this.projectRootDirectory})}catch(o){console.log("Error patching playwright",o.message)}}getPlaywrightReportPath(){let t=u(s=>(console.log("Using report folder",s),(0,a.join)(s,"index.html")),"makeFilePath");if(process.env.PLAYWRIGHT_HTML_REPORT)return t(process.env.PLAYWRIGHT_HTML_REPORT);let e=require(this.getPlaywrightConfigFile()),{reporter:o}=e;if(o instanceof Array){let n=o.filter(c=>c instanceof Array&&c[0]==="html").find(c=>{var h;return(h=c[1])==null?void 0:h.outputFolder});if(n)return t(n[1].outputFolder)}return t(this.projectRootDirectory)}getPlaywrightConfigFile(){return(0,a.join)(this.checksumRoot,"playwright.config.ts")}startTestRunMonitor(t){return new Promise(e=>{console.log("Starting test run monitor"),this.testRunMonitorProcess=g.spawn("node",[this.TEST_RUN_MONITOR_PATH,JSON.stringify({sessionId:t,checksumApiURL:this.CHECKSUM_API_URL,apiKey:this.config.apiKey}),...this.isolationMode?["isolated"]:[]]),this.testRunMonitorProcess.stdout.on("data",o=>{let s=o.toString().trim();if(l("[trm] "+s),!s.startsWith("monitor"))return;let[n,c]=s.substring(s.indexOf(":")+1).split("=");n==="port"?e(c):this.handleTestRunMonitorMessage(n,c)}),this.testRunMonitorProcess.on("exit",(o,s)=>{console.log(`test run monitor process exited with code ${o} and signal ${s}`)}),this.testRunMonitorProcess.on("error",o=>{console.error(`Error starting test run monitor: ${o.message}`)})})}async handleTestRunMonitorMessage(t,e){switch(l(`Handling test run monitor message ${this.isolationMode?"(isolation mode)":""}`,t,e),t){case"complete-with-errors":console.log("Error uploading test files to Checksum"),this.sendProcessingError().then(()=>{this.completeIndicators.upload=!0});break;case"complete":this.isolationMode||console.log("Test files uploaded successfully"),this.sendUploadsComplete().then(()=>{this.completeIndicators.upload=!0});break;case"report-uploaded":{if(this.isolationMode){this.completeIndicators.report=!0;break}console.log("Report generated and uploaded to Checksum");let o={};try{o=JSON.parse(e)}catch(s){console.log("Error parsing stats",s.message)}await this.sendTestRunEnd(o),this.completeIndicators.report=!0,console.log(`*******************
* Checksum report URL: ${this.CHECKSUM_APP_URL}/#/test-runs/${this.testSession}
*******************`);break}default:console.warn(`Unhandled test run monitor message: ${t}=${e}`)}}async handleCompleteMessage(){for(;;)Object.keys(this.completeIndicators).find(t=>!this.completeIndicators[t])?(l(this.completeIndicators),await this.awaitSleep(1e3)):(console.log("Checksum test run complete"),this.shutdown(this.didFail?1:0))}shutdown(t=0){this.cleanup(),process.exit(t)}buildVolatileConfig(){if(!this.volatileChecksumConfig)return;let t=this.getVolatileConfigPath(),e=`
    import { RunMode, getChecksumConfig } from "@checksum-ai/runtime";
    
    export default getChecksumConfig(${JSON.stringify(this.config,null,2)});
    `;(0,r.writeFileSync)(t,e)}cleanup(){var t,e;this.deleteVolatileConfig(),(t=this.testRunMonitorProcess)==null||t.stdin.write("cli:shutdown"),(e=this.testRunMonitorProcess)==null||e.kill()}async getSession(){try{if(!this.config.options.hostReports)return this.setIsolatedMode(),!0;let t=this.config.apiKey;if(!t||t==="<API key>")return this.printError("No API key found in checksum config - please set it in the config file - checksum.config.ts"),this.shutdown(1),!1;let e=JSON.stringify(await this.getEnvInfo()),o=await fetch(`${this.CHECKSUM_API_URL}/client-api/test-runs`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",ChecksumAppCode:t},body:e});return this.testSession=(await o.json()).uuid,!0}catch{return console.log("Error connecting to Checksum, the report will not be hosted"),this.setIsolatedMode(),!0}}setIsolatedMode(){this.isolationMode=!0,this.testSession="isolated-session"}async sendTestRunEnd(t){if(!this.isolationMode)try{l("Sending test run end",t);let e=JSON.stringify({...t,endedAt:Date.now()});await this.updateTestRun(`${this.CHECKSUM_API_URL}/client-api/test-runs/${this.testSession}`,"PATCH",e)}catch(e){return console.log("Error sending test run end",e.message),null}}async sendUploadsComplete(){if(!this.isolationMode)try{await this.updateTestRun(`${this.CHECKSUM_API_URL}/client-api/test-runs/${this.testSession}/uploads-completed`,"PATCH")}catch(t){console.log("Error sending test run uploads complete",t.message)}}async sendProcessingError(){if(!this.isolationMode)try{await this.updateTestRun(`${this.CHECKSUM_API_URL}/client-api/test-runs/${this.testSession}/process-error`,"PATCH")}catch(t){console.log("Error sending test run processing error",t.message)}}async updateTestRun(t,e,o=void 0){let s=await fetch(t,{method:e,headers:{Accept:"application/json","Content-Type":"application/json",ChecksumAppCode:this.config.apiKey},body:o});return l("Received update test run response from url:",t),await this.logApiResponse(s),s}async logApiResponse(t){try{if(!t.ok){l("HTTP Error:",t.status,t.statusText);let o=await t.text();l("Error Details:",o);return}t.headers.get("Content-Type").includes("application/json")?t.json().then(o=>{l("API Response:",o)}):t.text().then(o=>{l("API Response:",o)})}catch(e){l("Error logging API response",e.message)}}async getEnvInfo(){let t={commitHash:"",branch:"branch",environment:process.env.CI?"CI":"local",name:"name",startedAt:Date.now()};try{t.commitHash=(await this.getCmdOutput("git rev-parse HEAD")).toString().trim()}catch(e){console.log("Error getting git hash",e.message)}try{t.branch=(await this.getCmdOutput("git rev-parse --abbrev-ref HEAD")).toString().trim()}catch(e){console.log("Error getting branch",e.message)}try{t.name=(await this.getCmdOutput("git log -1 --pretty=%B")).toString().trim()}catch(e){console.log("Error getting name",e.message)}return t}getVolatileConfigPath(){return(0,a.join)(this.checksumRoot,"checksum.config.tmp.ts")}deleteVolatileConfig(){let t=this.getVolatileConfigPath();(0,r.existsSync)(t)&&(0,r.rmSync)(t)}setChecksumConfig(){this.config={...require((0,a.join)(this.checksumRoot,"checksum.config.ts")).default||{},...this.volatileChecksumConfig||{}},this.debugMode&&(this.config.options.printLogs=!0),this.config.apiURL&&(this.CHECKSUM_API_URL=this.config.apiURL)}processChecksumArguments(t){this.deleteVolatileConfig();for(let e=0;e<t.length;e++){let o=t[e];if(o.startsWith("--checksum-config"))try{this.volatileChecksumConfig=JSON.parse(o.split("=")[1]),t.splice(e,1)}catch(s){console.log("Error parsing checksum config",s.message),this.volatileChecksumConfig=void 0}o==="--clidebug"&&t.splice(e,1)}}install(){console.log("Creating Checksum directory and necessary files to run your tests");try{this.findChecksumRootOrigin()}catch(o){console.log(o.message),process.exit(1)}let t=(0,a.join)(process.cwd(),d);if((0,r.existsSync)(t)||(0,r.mkdirSync)(t),!(0,r.existsSync)(this.getChecksumRootOrigin()))throw new Error("Could not find checksum root directory, please install @checksum-ai/runtime package");let e=(0,r.existsSync)((0,a.join)(t,"checksum.config.ts"));w({isInit:!e}).forEach(o=>{let s=(0,a.join)(t,o);(0,r.existsSync)(s)||(0,r.copyFileSync)((0,a.join)(this.getChecksumRootOrigin(),o),s)}),(0,r.mkdirSync)((0,a.join)(t,"tests"),{recursive:!0}),["esra","har","trace","log"].forEach(o=>{(0,r.mkdirSync)((0,a.join)(t,"test-data",o),{recursive:!0})})}getChecksumRootOrigin(){return(0,a.join)(this.projectRootDirectory,"node_modules","@checksum-ai","runtime","checksum-root")}locateChecksumLibs(){try{this.findChecksumRootOrigin(),this.findChecksumRoot(),l("Project root found at",this.projectRootDirectory),l("Checksum root found at",this.checksumRoot)}catch(t){console.log(t.message),process.exit(1)}}findChecksumRootOrigin(){let t=process.cwd();for(let e=0;e<6;e++){let o=(0,a.join)(t,"node_modules","@checksum-ai","runtime","checksum-root");if((0,r.existsSync)(o)){this.projectRootDirectory=t;return}if((0,a.parse)(t).root===t)break;t=(0,a.join)(t,"..")}throw new Error("Could not resolve checksum root origins")}findChecksumRoot(){let t=u(e=>{try{return(0,r.readdirSync)(e).includes("checksum.config.ts")}catch{return!1}},"containsChecksumConfig");try{let e=[this.projectRootDirectory];for(;e.length;){let o=e.pop(),s=(0,r.readdirSync)(o,{withFileTypes:!0});for(let n of s)if(n.isDirectory()){let c=(0,a.join)(o,n.name);if(n.name===d){if(t(c)){this.checksumRoot=c;return}}else e.push(c)}}}catch(e){throw e}throw new Error("Could not find checksum root folder. Run `npx checksumai init` to create one.")}};u(p,"ChecksumCLI");(async()=>await new p().execute())();
